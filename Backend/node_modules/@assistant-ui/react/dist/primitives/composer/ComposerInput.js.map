{"version":3,"sources":["../../../src/primitives/composer/ComposerInput.tsx"],"sourcesContent":["\"use client\";\n\nimport { composeEventHandlers } from \"@radix-ui/primitive\";\nimport { useComposedRefs } from \"@radix-ui/react-compose-refs\";\nimport { Slot } from \"@radix-ui/react-slot\";\nimport {\n  ClipboardEvent,\n  type KeyboardEvent,\n  forwardRef,\n  useCallback,\n  useEffect,\n  useRef,\n} from \"react\";\nimport TextareaAutosize, {\n  type TextareaAutosizeProps,\n} from \"react-textarea-autosize\";\nimport { useEscapeKeydown } from \"@radix-ui/react-use-escape-keydown\";\nimport { useOnScrollToBottom } from \"../../utils/hooks/useOnScrollToBottom\";\nimport { useAssistantState, useAssistantApi } from \"../../context\";\n\nexport namespace ComposerPrimitiveInput {\n  export type Element = HTMLTextAreaElement;\n  export type Props = TextareaAutosizeProps & {\n    /**\n     * Whether to render as a child component using Slot.\n     * When true, the component will merge its props with its child.\n     */\n    asChild?: boolean | undefined;\n    /**\n     * Whether to submit the message when Enter is pressed (without Shift).\n     * @default true\n     */\n    submitOnEnter?: boolean | undefined;\n    /**\n     * Whether to cancel message composition when Escape is pressed.\n     * @default true\n     */\n    cancelOnEscape?: boolean | undefined;\n    /**\n     * Whether to automatically focus the input when a new run starts.\n     * @default true\n     */\n    unstable_focusOnRunStart?: boolean | undefined;\n    /**\n     * Whether to automatically focus the input when scrolling to bottom.\n     * @default true\n     */\n    unstable_focusOnScrollToBottom?: boolean | undefined;\n    /**\n     * Whether to automatically focus the input when switching threads.\n     * @default true\n     */\n    unstable_focusOnThreadSwitched?: boolean | undefined;\n    /**\n     * Whether to automatically add pasted files as attachments.\n     * @default true\n     */\n    addAttachmentOnPaste?: boolean | undefined;\n  };\n}\n\n/**\n * A text input component for composing messages.\n *\n * This component provides a rich text input experience with automatic resizing,\n * keyboard shortcuts, file paste support, and intelligent focus management.\n * It integrates with the composer context to manage message state and submission.\n *\n * @example\n * ```tsx\n * <ComposerPrimitive.Input\n *   placeholder=\"Type your message...\"\n *   submitOnEnter={true}\n *   addAttachmentOnPaste={true}\n * />\n * ```\n */\nexport const ComposerPrimitiveInput = forwardRef<\n  ComposerPrimitiveInput.Element,\n  ComposerPrimitiveInput.Props\n>(\n  (\n    {\n      autoFocus = false,\n      asChild,\n      disabled: disabledProp,\n      onChange,\n      onKeyDown,\n      onPaste,\n      submitOnEnter = true,\n      cancelOnEscape = true,\n      unstable_focusOnRunStart = true,\n      unstable_focusOnScrollToBottom = true,\n      unstable_focusOnThreadSwitched = true,\n      addAttachmentOnPaste = true,\n      ...rest\n    },\n    forwardedRef,\n  ) => {\n    const api = useAssistantApi();\n\n    const value = useAssistantState(({ composer }) => {\n      if (!composer.isEditing) return \"\";\n      return composer.text;\n    });\n\n    const Component = asChild ? Slot : TextareaAutosize;\n\n    const isDisabled =\n      useAssistantState(({ thread }) => thread.isDisabled) || disabledProp;\n    const textareaRef = useRef<HTMLTextAreaElement>(null);\n    const ref = useComposedRefs(forwardedRef, textareaRef);\n\n    useEscapeKeydown((e) => {\n      if (!cancelOnEscape) return;\n\n      const composer = api.composer();\n      if (composer.getState().canCancel) {\n        composer.cancel();\n        e.preventDefault();\n      }\n    });\n\n    const handleKeyPress = (e: KeyboardEvent) => {\n      if (isDisabled || !submitOnEnter) return;\n\n      // ignore IME composition events\n      if (e.nativeEvent.isComposing) return;\n\n      if (e.key === \"Enter\" && e.shiftKey === false) {\n        const isRunning = api.thread().getState().isRunning;\n\n        if (!isRunning) {\n          e.preventDefault();\n\n          textareaRef.current?.closest(\"form\")?.requestSubmit();\n        }\n      }\n    };\n\n    const handlePaste = async (e: ClipboardEvent<HTMLTextAreaElement>) => {\n      if (!addAttachmentOnPaste) return;\n      const threadCapabilities = api.thread().getState().capabilities;\n      const files = Array.from(e.clipboardData?.files || []);\n\n      if (threadCapabilities.attachments && files.length > 0) {\n        try {\n          e.preventDefault();\n          await Promise.all(\n            files.map((file) => api.composer().addAttachment(file)),\n          );\n        } catch (error) {\n          console.error(\"Error adding attachment:\", error);\n        }\n      }\n    };\n\n    const autoFocusEnabled = autoFocus && !isDisabled;\n    const focus = useCallback(() => {\n      const textarea = textareaRef.current;\n      if (!textarea || !autoFocusEnabled) return;\n\n      textarea.focus({ preventScroll: true });\n      textarea.setSelectionRange(textarea.value.length, textarea.value.length);\n    }, [autoFocusEnabled]);\n\n    useEffect(() => focus(), [focus]);\n\n    useOnScrollToBottom(() => {\n      if (\n        api.composer().getState().type === \"thread\" &&\n        unstable_focusOnScrollToBottom\n      ) {\n        focus();\n      }\n    });\n\n    useEffect(() => {\n      if (\n        api.composer().getState().type !== \"thread\" ||\n        !unstable_focusOnRunStart\n      )\n        return undefined;\n\n      return api.on(\"thread.run-start\", focus);\n    }, [unstable_focusOnRunStart, focus, api]);\n\n    useEffect(() => {\n      if (\n        api.composer().getState().type !== \"thread\" ||\n        !unstable_focusOnThreadSwitched\n      )\n        return undefined;\n\n      return api.on(\"thread-list-item.switched-to\", focus);\n    }, [unstable_focusOnThreadSwitched, focus, api]);\n\n    return (\n      <Component\n        name=\"input\"\n        value={value}\n        {...rest}\n        ref={ref as React.ForwardedRef<HTMLTextAreaElement>}\n        disabled={isDisabled}\n        onChange={composeEventHandlers(onChange, (e) => {\n          if (!api.composer().getState().isEditing) return;\n          api.composer().setText(e.target.value);\n          api.flushSync();\n        })}\n        onKeyDown={composeEventHandlers(onKeyDown, handleKeyPress)}\n        onPaste={composeEventHandlers(onPaste, handlePaste)}\n      />\n    );\n  },\n);\n\nComposerPrimitiveInput.displayName = \"ComposerPrimitive.Input\";\n"],"mappings":"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","names":[]}